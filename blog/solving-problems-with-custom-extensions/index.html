<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Solving problems with custom Quarkus extensions</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/solving-problems-with-custom-extensions/" />
  <meta property="og:title" content="Solving problems with custom Quarkus extensions" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/solving-problems-with-custom-extensions/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="post">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
      
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
      
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <div id="menu" class="menu">
      <span>
        <a href="/get-started/" class="">Get Started</a>
      </span>
      <span>
        <a href="/guides/" class="">Guides</a>
      </span>
      <span>
        <a href="/community/" class="">Community</a>
      </span>
      <span>
        <a href="/support/" class="">Support</a>
      </span>
      <span>
        <a href="/blog/" class="active">Blog</a>
      </span>
      <span>
        <a href="https://code.quarkus.io" class="button-cta secondary white">Start Coding</a>
      </span>
    </div>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <p>
          <a href="/blog"><i class="fas fa-angle-left"></i> Back to all posts</a>
        </p>
      </div>
      <div class="width-12-12">
        <div class="post-date">
          April 20, 2021 
          
            <span class="tags"><a href="/blog/tag/development-tips">#development-tips</a><a href="/blog/tag/extensions">#extensions</a></span>
          
        </div>
        <h1 class="post-title">Solving problems with custom Quarkus extensions</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/ec96387a1a8295b6fd6dffb68f80c352">
            
            <p class="byline">By Guillaume Smet</p>
          </div>
          <div class="width-12-12">
              <div class="paragraph">
<p>From time to time, I see tweets or articles claiming they don&#8217;t see the point of Quarkus because "who needs fast startup?", "I have plenty of memory" or "what is the point of live reload?".</p>
</div>
<div class="paragraph">
<p>I could write an article debunking these arguments and explain how the latter makes your development workflow much more efficient and how the former makes the latter possible, even if fast boots are not your thing.
But for the sake of this blog post, let&#8217;s admit these persons are absolutely right and these are not good reasons to use Quarkus.</p>
</div>
<div class="paragraph">
<p>So now what? Back to <code>&lt;insert your favorite framework here&gt;</code>? Not so fast&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Quarkus didn&#8217;t achieve fast startup and low memory footprint by using dark magic or lazy loading tricks but by entirely rethinking the way Java applications are bootstrapped.
The whole point of Quarkus is to move as much work as possible to the build time and this journey made us create a framework to push work at build time that can be leveraged in Quarkus extensions.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A Quarkus extension? That sounds like a lot of work?</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>No, really, it is not.
You can develop your own extensions very easily and they can solve some out of the ordinary problems in a very simple way.</p>
</div>
<div class="paragraph">
<p>Last week, one of of our users (hey, Juan!) asked this question on Zulip:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Hi! I&#8217;m trying to understand how to find classes with some criteria and add them to the dependency injection context, for example: I want to find all classes whose name ends with "MessageTransformer" and add them to the context, I want to find those classes in an external library, so I can&#8217;t add annotations to them.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Let&#8217;s see how we can solve this issue by developing a custom extension.</p>
</div>
<div class="sect1">
<h2 id="creating-the-extension"><a class="anchor" href="#creating-the-extension"></a>Creating the extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Creating the extension is as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mvn io.quarkus:quarkus-maven-plugin:create-extension -DwithoutTests</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will ask for a <code>groupId</code> - let&#8217;s keep the default <code>org.acme</code> - and an extension id - I went for <code>message-transformers-as-beans</code>.</p>
</div>
<div class="paragraph">
<p>Then you can import your new extension into your favorite IDE.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="structure-of-the-extension"><a class="anchor" href="#structure-of-the-extension"></a>Structure of the extension</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a lot to say about extensions but, in the context of this blog post, we will keep it short.
The extension is composed of three Maven modules:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The parent module - nothing to see here</p>
</li>
<li>
<p>The deployment module - this is the one of interest for our blog post</p>
</li>
<li>
<p>The runtime module - in this blog post, we won&#8217;t modify it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s keep it simple: the deployment module is what will be used at build time, the runtime module is what will be used at runtime.</p>
</div>
<div class="paragraph">
<p>In our case, we want to declare new beans and this is something we do at build time, so deployment module, here we come!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="processors-and-build-steps"><a class="anchor" href="#processors-and-build-steps"></a>Processors and build steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have a look at your <code>deployment</code> module, you will see a <code>MessageTransformersAsBeansProcessor</code> and you can see a method annotated with the <code>@BuildStep</code> annotation in it.</p>
</div>
<div class="paragraph">
<p>Quarkus build is populated by these build steps and they are following a consumer/producer model with dependency injection.
The items being consumed and produced are called <code>BuildItem</code>s.</p>
</div>
<div class="paragraph">
<p>The build step that is automatically generated is easy to understand.
It produces a <code>FeatureBuildItem</code> which will be consumed by Quarkus startup and you will see the extension name in the list displayed by Quarkus at startup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">INFO  [io.quarkus] my-app 1.0.0-SNAPSHOT on JVM (powered by Quarkus 1.13.2.Final) started in 0.221s.
INFO  [io.quarkus] Profile prod activated.
INFO  [io.quarkus] Installed features: [cdi, message-transformers-as-beans]</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-jandex-index"><a class="anchor" href="#the-jandex-index"></a>The Jandex index</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we are done with the scaffolding, let&#8217;s think a bit about what we want to achieve:
we need to find all the classes in a given package whose name ends with <code>MessageTransformer</code>.</p>
</div>
<div class="paragraph">
<p>An important assumption of Quarkus is that the application lives in a closed world.
You cannot dynamically add a jar at runtime to your Quarkus application and expect it to work.</p>
</div>
<div class="paragraph">
<p>While it can be seen as a limitation, it opens all sorts of possibilities,
one of which is the ability to index the classes and their annotations to easily look them up.</p>
</div>
<div class="paragraph">
<p>This index, based on <a href="https://github.com/wildfly/jandex">Jandex</a>, is a very important part of the Quarkus bootstrap.</p>
</div>
<div class="paragraph">
<p>The Jandex index doesn&#8217;t contain all the classes around but is, by default, limited to the application classes and the dependencies containing either a pre-built index or an empty <code>META-INF/beans.xml</code>.</p>
</div>
<div class="paragraph">
<p>In our case, we want to list the classes of an external dependency so we will need to add them to the index.
We can do that very easily by adding a build step to <code>MessageTransformersAsBeansProcessor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
IndexDependencyBuildItem indexExternalDependency() {
    return new IndexDependencyBuildItem("my.group.id", "my-artifact-id");
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add the content of the <code>my.group.id:my-artifact-id</code> jar to the index.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="declaring-additional-beans"><a class="anchor" href="#declaring-additional-beans"></a>Declaring additional beans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have our classes indexed, we want to make them CDI beans.</p>
</div>
<div class="paragraph">
<p>This can be achieved by adding another build step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@BuildStep
void declareMessageTransformersAsBean(CombinedIndexBuildItem index, <i class="conum" data-value="1"></i><b>(1)</b>
        BuildProducer&lt;AdditionalBeanBuildItem&gt; additionalBeans) { <i class="conum" data-value="2"></i><b>(2)</b>
    List&lt;String&gt; messageTransformers = index.getIndex().getKnownClasses().stream() <i class="conum" data-value="3"></i><b>(3)</b>
            .filter(ci -&gt; !Modifier.isAbstract(ci.flags())) <i class="conum" data-value="4"></i><b>(4)</b>
            .map(ci -&gt; ci.name().toString()) <i class="conum" data-value="5"></i><b>(5)</b>
            .filter(c -&gt; c.startsWith("my.package.")) <i class="conum" data-value="6"></i><b>(6)</b>
            .filter(c -&gt; c.endsWith("MessageTransformer")) <i class="conum" data-value="7"></i><b>(7)</b>
            .collect(Collectors.toList());

    additionalBeans.produce(new AdditionalBeanBuildItem.Builder() <i class="conum" data-value="8"></i><b>(8)</b>
            .addBeanClasses(messageTransformers)
            .setUnremovable() <i class="conum" data-value="9"></i><b>(9)</b>
            .setDefaultScope(DotNames.APPLICATION_SCOPED) <i class="conum" data-value="10"></i><b>(10)</b>
            .build());
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Consume the Jandex index</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the additional beans producer</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Get all known classes from the index</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Filter out abstract classes</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Get the FQCN of the class</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Only keep classes from the root package we target</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Only keep <code>MessageTransformer</code>s</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Produce an <code>AdditionalBeanBuildItem</code></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Make the beans unremovable to prevent ArC from removing the beans if they are only programatically consumed</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Set the default scope to <code>@ApplicationScoped</code> - can be any CDI scope of your preference</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this build step, any non-abstract class from our root package <code>my.package</code> whose name ends with <code>MessageTransformer</code>
will be made an <code>@ApplicationScoped</code> CDI bean.</p>
</div>
<div class="paragraph">
<p>Cherry on top, all this work is done at build time and you don&#8217;t need to scan your entire classpath at runtime.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Usually, we look up classes in the index with an interface, a superclass or an annotation.
It is less brittle and faster than crawling the whole index and filter by name.</p>
</div>
<div class="paragraph">
<p>But the point here was to do with the constraints of the user and it wasn&#8217;t an option to adapt the external dependency.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="thats-all-folks"><a class="anchor" href="#thats-all-folks"></a>That&#8217;s all, folks!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Obviously, this is a very simple example and you can do much more complex things with a Quarkus extension.</p>
</div>
<div class="paragraph">
<p>But the whole point of this blog post was to demonstrate that you can easily leverage our extension framework to solve real-life issues.
And <strong>in ~10 minutes of coding, our problem is gone</strong>.</p>
</div>
<div class="paragraph">
<p>Next one?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="come-join-us"><a class="anchor" href="#come-join-us"></a>Come Join Us</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We value your feedback a lot so please report bugs, ask for improvements&#8230;&#8203; Let&#8217;s build something great together!</p>
</div>
<div class="paragraph">
<p>If you are a Quarkus user or just curious, don&#8217;t be shy and join our welcoming community:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>provide feedback on <a href="https://github.com/quarkusio/quarkus/issues">GitHub</a>;</p>
</li>
<li>
<p>craft some code and <a href="https://github.com/quarkusio/quarkus/pulls">push a PR</a>;</p>
</li>
<li>
<p>discuss with us on <a href="https://quarkusio.zulipchat.com/">Zulip</a> and on the <a href="https://groups.google.com/d/forum/quarkus-dev">mailing list</a>;</p>
</li>
<li>
<p>ask your questions on <a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a>.</p>
</li>
</ul>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/solving-problems-with-custom-extensions/&title=Solving problems with custom Quarkus extensions" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <img src="/assets/images/share-page/icons_social-linkedin.png"/>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Solving problems with custom Quarkus extensions&url=https://quarkus.io/blog/solving-problems-with-custom-extensions/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on Twitter">
    <img src="/assets/images/share-page/icons_social-twitter.png"/>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/solving-problems-with-custom-extensions/" rel="nofollow" target="_blank" title="Share on Facebook">
    <img src="/assets/images/share-page/icons_social-facebook.png"/>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/solving-problems-with-custom-extensions/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <img src="/assets/images/share-page/icons_social-reddit.png"/>
  </a>
  <a class="share-email" href="mailto:?subject=Solving problems with custom Quarkus extensions&amp;body=Solving problems with custom Quarkus extensions https://quarkus.io/blog/solving-problems-with-custom-extensions/" title="Share via Email" >
    <img src="/assets/images/share-page/icons_social-email.png"/>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/community/#contributing">Contribute</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
            <li><a href="/security">Security&nbsp;policy</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://quarkusio.zulipchat.com">Chat room</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Development mailing list</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
</body>

</html>

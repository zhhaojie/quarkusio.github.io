<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Narayana LRA Participant Support - main</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/version/main/guides/lra" />
  <meta property="og:title" content="Narayana LRA Participant Support - main" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/guides/lra">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="guides">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
      
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
      
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <div id="menu" class="menu">
      <span>
        <a href="/get-started/" class="">Get Started</a>
      </span>
      <span>
        <a href="/guides/" class="active">Guides</a>
      </span>
      <span>
        <a href="/community/" class="">Community</a>
      </span>
      <span>
        <a href="/support/" class="">Support</a>
      </span>
      <span>
        <a href="/blog/" class="">Blog</a>
      </span>
      <span>
        <a href="https://code.quarkus.io" class="button-cta secondary white">Start Coding</a>
      </span>
    </div>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    


<div class="grid-wrapper guide">
  <div class="grid__item width-9-12 width-12-12-mobile">
    <h1 class="text-caps">Narayana LRA Participant Support </h1>
  </div>
  <div class="grid__item width-3-12 align-self-center text-right hide-mobile">
    <label id="guide-version-label">Select Guide Version</label>
    <select id="guide-version-dropdown">
      
        
        
        
        
          <option value="main" selected>Main - SNAPSHOT</option>
        
      
        
        
        
        
          <option value="latest" >2.2 - Latest</option>
        
      
        
        
        
        
      
        
        
        
        
      
    </select>
  </div>
  <div class="width-12-12">
    <div class="hide-mobile toc"><ul class="sectlevel1">
<li><a href="#introduction">Introduction</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#handling-failures">Handling failures</a></li>
<li><a href="#examples">Examples</a></li>
</ul></div>
    <div>
      <div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The LRA (short for Long Running Action) participant extension is useful in microservice based
designs where different services can benefit from a relaxed notion of distributed consistency.</p>
</div>
<div class="paragraph">
<p>The idea is for multiple services to perform different computations/actions in concert, whilst
retaining the option to compensate for any actions performed during the computation.
This kind of loose coupling of services bridges the gap between strong consistency models
such as JTA/XA and "home grown" ad hoc consistency solutions.</p>
</div>
<div class="paragraph">
<p>The model is based on the <a href="https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc#eclipse-microprofile-lra">Eclipse MicroProfile LRA specification</a>.
The approach is for the developer to annotate a business method with a Java annotation
(<a href="https://download.eclipse.org/microprofile/microprofile-lra-1.0/apidocs/"><code>@LRA</code></a>).
When such a method is called, an LRA context is created (if one is not already present) which is passed
along with subsequent JAX-RS invocations until a method is reached
which also contains an <code>@LRA</code> annotation with an attribute that indicates that the LRA should be
closed or cancelled. The default is for the LRA to be closed in the same method that started the
LRA (which itself may have propagated the context during method execution).
The JAX-RS resource indicates that it wishes to participate in the interaction by, minimally,
marking one of the methods with an
<a href="https://download.eclipse.org/microprofile/microprofile-lra-1.0/apidocs/"><code>@Compensate</code></a>
annotation. If the context is later cancelled then this compensate action is guaranteed to be
called even in the presence of failures and is the trigger for the resource to compensate for any
activities it performed in the context of the LRA. This guarantee enables services to operate
reliably with the assurance of eventual consistency (when all compensation activities have
ran to completion). The participant can ask to be reliably notified when the LRA it is participating
in is closed by marking one of the methods with an
<a href="https://download.eclipse.org/microprofile/microprofile-lra-1.0/apidocs/"><code>@Complete</code></a>
annotation. In this way cancelling an LRA causes all participants to be notified via their Compensate callback
and closing an LRA causes all participants to be notified via their Complete callback (if they have one).
Other annotations for controlling participants are documented in the
<a href="https://download.eclipse.org/microprofile/microprofile-lra-1.0/apidocs/">MicroProfile LRA API v1.0 javadoc</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have your Quarkus Maven project configured you can add the <code>narayana-lra</code> extension
by running the following command in your project base directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw quarkus:add-extension -Dextensions="narayana-lra"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will add the following to your pom.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;dependency&gt;
        &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;quarkus-narayana-lra&lt;/artifactId&gt;
    &lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is a running coordinator then this is all you need in order to create
new LRAs and to enlist participants with them.</p>
</div>
<div class="paragraph">
<p>The LRA extension can be configured by updating an <code>application.properties</code> file
in the <code>src/main/resources</code> directory. The only LRA specific property is
<code>quarkus.lra.coordinator-url=&lt;url&gt;</code> which specifies the HTTP endpoint of an external
coordinator, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">quarkus.lra.coordinator-url=http://localhost:8080/lra-coordinator</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a Narayana coordinator the path component of the url is normally <code>lra-coordinator</code>.
Coordinators can be obtained from <code><a href="https://hub.docker.com/r/jbosstm/lra-coordinator" class="bare">https://hub.docker.com/r/jbosstm/lra-coordinator</a></code>
or you can build your own coordinator using a maven pom that includes the appropriate
dependencies. A Quarkus quickstart will be provided to show how to do this or you can
take a look at one of the <a href="https://github.com/jbosstm/quickstart/tree/master/rts/lra-examples/lra-coordinator">Narayana quickstarts</a>.
Another option would be to run it managed inside a WildFly application server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="handling-failures"><a class="anchor" href="#handling-failures"></a>Handling failures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When an LRA is told to finish, i.e. when a method annotated with <code>@LRA(end = true, &#8230;&#8203;)</code>
is invoked, the coordinator will instruct all services involved in the interaction to
finish. If a service is unavailable (or still finishing) then the coordinator will retry
periodically. It is the users responsibility to restart failed services on the same
endpoint that they used when they first joined the LRA, or to tell the coordinator that
they wish to be notified on new endpoints. An LRA is not deemed finished until <strong>all</strong>
participants have acknowledged that they have finished.</p>
</div>
<div class="paragraph">
<p>The coordinator is responsible for reliably creating and ending LRAs and for managing
participant enlistment and it therefore must be available (for example if it or the
network fail then something in the environment is responsible for restarting
the coordinator or for repairing the network, respectively). To fulfill this task the
coordinator must have access to durable storage for its logs (via a filesystem or in
a database).  At the time of writing, managing coordinators is the responsibility of
the user. An "out-of-the-box" solution will be forthcoming.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following is a simple example of how to start an LRA and how to receive a notification
when the LRA is later cancelled (the <code>@Compensate</code> annotated method is called) or closed
(<code>@Complete</code> is called):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Path("/")
@ApplicationScoped
public class SimpleLRAParticipant
{
    @LRA(LRA.Type.REQUIRES_NEW) // a new LRA is created on method entry
    @Path("/work")
    @PUT
    public void doInNewLongRunningAction(@HeaderParam(LRA_HTTP_CONTEXT_HEADER) URI lraId)
    {
        /*
         * Perform business actions in the context of the LRA identified by the
         * value in the injected JAX-RS header. This LRA was started just before
         * the method was entered (REQUIRES_NEW) and will be closed when the
         * method finishes at which point the completeWork method below will be
         * invoked.
         */
    }

    @org.eclipse.microprofile.lra.annotation.Complete
    @Path("/complete")
    @PUT
    public Response completeWork(@HeaderParam(LRA_HTTP_CONTEXT_HEADER) URI lraId,
                                 String userData)
    {
        /*
         * Free up resources allocated in the context of the LRA identified by the
         * value in the injected JAX-RS header.
         *
         * Since there is no @Status method in this class, completeWork MUST be
         * idempotent and MUST return the status.
         */
         return Response.ok(ParticipantStatus.Completed.name()).build();
    }

    @org.eclipse.microprofile.lra.annotation.Compensate
    @Path("/compensate")
    @PUT
    public Response compensateWork(@HeaderParam(LRA_HTTP_CONTEXT_HEADER) URI lraId,
                                   String userData)
    {
        /*
         * The LRA identified by the value in the injected JAX-RS header was
         * cancelled so the business logic should compensate for any actions
         * that have been performed while running in its context.
         *
         * Since there is no @Status method in this class, compensateWork MUST be
         * idempotent and MUST return the status
         */
         return Response.ok(ParticipantStatus.Compensated.name()).build();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example also shows that when an LRA is present its identifier can be obtained
by reading the request headers via the <code>@HeaderParam</code> JAX-RS annotation type.</p>
</div>
<div class="paragraph">
<p>And here&#8217;s an example of how to start an LRA in one resource method and close it in
a different resource method using the <code>end</code> element of the <code>LRA</code> annotation. It also
shows how to configure the LRA to be automatically cancelled if the business method
returns the particular HTTP status codes identified in the <code>cancelOn</code> and
<code>cancelOnFamily</code> elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">  @LRA(value = LRA.Type.REQUIRED, // if there is no incoming context a new one is created
       cancelOn = {
           Response.Status.INTERNAL_SERVER_ERROR // cancel on a 500 code
       },
       cancelOnFamily = {
           Response.Status.Family.CLIENT_ERROR // cancel on any 4xx code
       },
       end = false) // the LRA will continue to run when the method finishes
  @Path("/book")
  @POST
  public Response bookTrip(...) { ... }

  @LRA(LRA.Type.MANDATORY, // requires an active context before method can be executed
       end = true) // end the LRA started by the bookTrip method
  @Path("/confirm")
  @PUT
  public Booking confirmTrip(Booking booking) throws BookingException { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>end = false</code> element on the bookTrip method forces the LRA to continue running when
the method finishes and the <code>end = true</code> element on the confirmTrip method forces the LRA
(started by the bookTrip method) to be closed when the method finishes. Note that this
end element can be placed on any JAX-RS resource (ie one service can start the LRA whilst
a different service ends it). There are many more examples in the
<a href="https://github.com/eclipse/microprofile-lra/blob/master/spec/src/main/asciidoc/microprofile-lra-spec.adoc#java-annotations">Microprofile LRA specification document</a> and in the <a href="https://github.com/eclipse/microprofile-lra/tree/master/tck/src/main/java/org/eclipse/microprofile/lra/tck">Microprofile LRA TCK</a>.</p>
</div>
</div>
</div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/community/#contributing">Contribute</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
            <li><a href="/security">Security&nbsp;policy</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://quarkusio.zulipchat.com">Chat room</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Development mailing list</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
</body>

</html>

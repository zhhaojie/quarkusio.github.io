<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Mutiny - How does retry... retries?</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/uni-retry/" />
  <meta property="og:title" content="Mutiny - How does retry... retries?" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/uni-retry/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="post">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
      
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
      
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <div id="menu" class="menu">
      <span>
        <a href="/get-started/" class="">Get Started</a>
      </span>
      <span>
        <a href="/guides/" class="">Guides</a>
      </span>
      <span>
        <a href="/community/" class="">Community</a>
      </span>
      <span>
        <a href="/support/" class="">Support</a>
      </span>
      <span>
        <a href="/blog/" class="active">Blog</a>
      </span>
      <span>
        <a href="https://code.quarkus.io" class="button-cta secondary white">Start Coding</a>
      </span>
    </div>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <p>
          <a href="/blog"><i class="fas fa-angle-left"></i> Back to all posts</a>
        </p>
      </div>
      <div class="width-12-12">
        <div class="post-date">
          October 13, 2020 
          
            <span class="tags"><a href="/blog/tag/reactive">#reactive</a><a href="/blog/tag/mutiny">#mutiny</a><a href="/blog/tag/retry">#retry</a></span>
          
        </div>
        <h1 class="post-title">Mutiny - How does retry... retries?</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/ab937f7df990a673446f1e30fd9ccfba">
            
            <p class="byline">By Clement Escoffier</p>
          </div>
          <div class="width-12-12">
              <div class="paragraph">
<p>Last week, David, a Quarkus user, asked me about retrying an asynchronous operation.
David has a <em>picky</em> remote HTTP service, which sometimes misbehaves.
Easy answer!
Just do: <code>uni.onFailure().retry().atMost(x)</code>.
But, David is curious, and asked me a second question: how does retry work?
Well, that’s simple; it just retries&#8230;&#8203;
As you can imagine, that did not satisfy David’s curiosity.</p>
</div>
<div class="paragraph">
<p>While I was answering to David, I realized that retrying is not that simple and deserves more explanation.
That’s what we are going to see in this blog post.</p>
</div>
<div class="sect1">
<h2 id="disclaimer-about-retries"><a class="anchor" href="#disclaimer-about-retries"></a>Disclaimer about retries</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Okay, if you are the kind of reader who skips the terms and conditions, you can jump to the next section.
But, for others, I need to warn you about retries.
Retries may not be the solution to your problem, as it can be terrible.
Retrying can only be done if your system can handle duplicated requests or messages.
In other words, you can only retry if your system is idempotent, i.e., sending a request or a message multiple times does not change the overall state.
In doubt, check before implementing a retry, as it can harm your system.</p>
</div>
<div class="paragraph">
<p>Disclaimer said! Let’s look under the hood of retry.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retry-is-about-resubscribing"><a class="anchor" href="#retry-is-about-resubscribing"></a>Retry is about resubscribing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let’s imagine you have a <code>Uni</code> representing your asynchronous action, like in David’s case, an invocation of a remote service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;String&gt; uni = invokePickyService(client);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unis are lazy.
Until someone subscribes to them, nothing happens.
In our case, the request is only sent to the remote service when someone subscribes to the <code>uni</code>.
So to execute the request, we need to subscribe:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;String&gt; uni = invokePickyService(client);
uni.subscribe().with(
    resp -&gt; System.out.println("Success: " + resp),
    failure -&gt; System.out.println("Failed: " + failure.getMessage())
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Quarkus, most of the time, you return the <code>Uni</code>, and Quarkus subscribes to it.
So, don&#8217;t be mistaken, there is a subscription, you may not see it.</p>
</div>
<div class="paragraph">
<p>This laziness is the retry secret.
In the following sequence diagram, you can see that the request is sent when we get a subscriber:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-retry/subscription.png" alt="subscription"></span></p>
</div>
<div class="paragraph">
<p>An interesting consequence of this is that if you subscribe twice, you emit two requests, and so get two responses:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-retry/double-subscription.png" alt="double subscription"></span></p>
</div>
<div class="paragraph">
<p>But let’s go back to retry.
What’s a retry?
A retry is a reaction to a failure, so you are going to write: <code>uni.onFailure().retry()</code>.
You also need to indicate how long do you want to retry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;String&gt; uni = invokePickyService(client)
    .onFailure().retry().indefinitely();
uni.subscribe().with(
        resp -&gt; System.out.println("Success: " + resp)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this snippet, we retry <em>indefinitely</em> until we get a successful result.</p>
</div>
<div class="paragraph">
<p>But, how does it work under the hood?
It’s quite simple.
If it gets a failure, it just re-subscribes:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-retry/retry.png" alt="retry"></span></p>
</div>
<div class="paragraph">
<p>It resubscribes until it gets a successful response.
In other words, retrying is resubscribing.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="how-many-times-should-i-retry"><a class="anchor" href="#how-many-times-should-i-retry"></a>How many times should I retry?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>That’s always a good question.
Should I retry <em>indefinitely</em>?
Most probably, not.
Indefinitely can be very long, and it could never end if the called service fails continuously.</p>
</div>
<div class="paragraph">
<p>You can configure the number of retries using <code>atMost</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"> Uni&lt;String&gt; uni = invokePickyService(client)
    .onFailure().retry().atMost(2);
uni.subscribe().with(
        resp -&gt; System.out.println("Success: " + resp),
        failure -&gt; System.out.println("Failure: " + failure.getMessage())
);</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>atMost</code> indicates that at most <code>n</code> attempts will be done before failing.
If we still get a failure after that number of resubscription, the last failure is sent to the subscriber.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-retry/retry-failed.png" alt="retry failed"></span></p>
</div>
<div class="paragraph">
<p>You can also use <code>until</code> and decide to retry by looking at the received failure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;String&gt; uni = invokePickyService(client)
    .onFailure().retry().until(failure -&gt; ! (failure instanceof TooManyRequestsException));</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bonus-exponential-backoff"><a class="anchor" href="#bonus-exponential-backoff"></a>Bonus: Exponential backoff</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far, our retries happen immediately.
It might not be very wise, and separating a bit our retries may give better results, especially when facing intermittent failures due to the load or other external causes.
Using exponential backoff provides a reasonable tradeoff.
Retrying with exponential backoff:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>retries after an initial delay,</p>
</li>
<li>
<p>on every failure, it doubles the previous delay, with an optional maximum,</p>
</li>
<li>
<p>it can use a jitter to add a random duration to the delay,</p>
</li>
<li>
<p>it can have a max delay if needed,</p>
</li>
<li>
<p>it is still constrained by <code>atMost</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Uni&lt;String&gt; uni = invokePickyService(client)
    .onFailure().retry()
        .withBackOff(Duration.ofSeconds(1)).withJitter(0.2).atMost(10);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This last snippet configures the retry with exponential backoff.
The first retry happens after 1 second, and then it doubles every time without an upper limit.
Random jitter is applied to delays.
If, unfortunately, after ten attempts, it still fails, the failure is sent to the subscriber.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="demo-time"><a class="anchor" href="#demo-time"></a>Demo time!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ok, enough talking.
I’ve built a simple playground where you can adjust and try the various retry policies: <a href="https://gist.github.com/cescoffier/e9abce907a1c3d05d70bea3dae6dc3d5" class="bare">https://gist.github.com/cescoffier/e9abce907a1c3d05d70bea3dae6dc3d5</a>.
You can <em>jbang</em> the script by downloading it and running <code>jbang Retry.java</code>, or just run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">jbang https://gist.github.com/cescoffier/e9abce907a1c3d05d70bea3dae6dc3d5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The called service fails 50% of the time (well, it uses a random, so statistically 50% of the time).</p>
</div>
<div class="paragraph">
<p>That concludes this blog post.
Again, before using retry, please verify that your system can support it.
Retrying is resubscribing.
You can configure how long, how many times, and when retrying should be attempted.
There are many more options offered by Mutiny, like <code>when</code> or using deadlines (<code>expireIn</code> and <code>expireAt</code>) when using exponential backoff.
You can try all these with the provided playground.</p>
</div>
<div class="paragraph">
<p>Stay tuned! We have plenty of other gems to discuss here!</p>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/uni-retry/&title=Mutiny - How does retry... retries?" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <img src="/assets/images/share-page/icons_social-linkedin.png"/>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Mutiny - How does retry... retries?&url=https://quarkus.io/blog/uni-retry/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on Twitter">
    <img src="/assets/images/share-page/icons_social-twitter.png"/>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/uni-retry/" rel="nofollow" target="_blank" title="Share on Facebook">
    <img src="/assets/images/share-page/icons_social-facebook.png"/>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/uni-retry/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <img src="/assets/images/share-page/icons_social-reddit.png"/>
  </a>
  <a class="share-email" href="mailto:?subject=Mutiny - How does retry... retries?&amp;body=Mutiny - How does retry... retries? https://quarkus.io/blog/uni-retry/" title="Share via Email" >
    <img src="/assets/images/share-page/icons_social-email.png"/>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/community/#contributing">Contribute</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
            <li><a href="/security">Security&nbsp;policy</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://quarkusio.zulipchat.com">Chat room</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Development mailing list</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
</body>

</html>

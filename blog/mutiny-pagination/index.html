<!DOCTYPE html>
<html>





<head>
  <title>Quarkus - Handling paginated APIs with Mutiny</title>
  <script id="adobe_dtm" src="https://www.redhat.com/dtm.js" type="text/javascript"></script>
  <script src="/assets/javascript/highlight.pack.js" type="text/javascript"></script>
  <META HTTP-EQUIV='X-XSS-Protection' CONTENT="1; mode=block">
  <META HTTP-EQUIV='X-Content-Type-Options' CONTENT="nosniff">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Quarkus: Supersonic Subatomic Java">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@QuarkusIO"> 
  <meta name="twitter:creator" content="@QuarkusIO">
  <meta property="og:url" content="https://quarkus.io/blog/mutiny-pagination/" />
  <meta property="og:title" content="Handling paginated APIs with Mutiny" />
  <meta property="og:description" content="Quarkus: Supersonic Subatomic Java" />
  <meta property="og:image" content="https://quarkus.io/assets/images/quarkus_card.png" />
  
  <link rel="canonical" href="https://quarkus.io/blog/mutiny-pagination/">
  <link rel="shortcut icon" type="image/png" href="/favicon.ico" >
  <link rel="stylesheet" href="/guides/stylesheet/config.css" />
  <link rel="stylesheet" href="/assets/css/main.css?2021-07-29" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="alternate" type="application/rss+xml"  href="/feed.xml" title="Quarkus">
  <script src="/assets/javascript/goan.js" type="text/javascript"></script>
  <script src="/assets/javascript/hl.js" type="text/javascript"></script>
</head>

<body class="post">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NJWS5L"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div class="nav-wrapper">
  <div class="grid-wrapper">
    <div class="width-12-12">
      <input type="checkbox" id="checkbox" />
      <nav id="main-nav" class="main-nav">
  <div class="container">
    <div class="logo-wrapper">
      
        <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_600px_reverse.png" class="project-logo" title="Quarkus"></a>
      
    </div>
    <label class="nav-toggle" for="checkbox">
      <i class="fa fa-bars"></i>
    </label>
    <div id="menu" class="menu">
      <span>
        <a href="/get-started/" class="">Get Started</a>
      </span>
      <span>
        <a href="/guides/" class="">Guides</a>
      </span>
      <span>
        <a href="/community/" class="">Community</a>
      </span>
      <span>
        <a href="/support/" class="">Support</a>
      </span>
      <span>
        <a href="/blog/" class="active">Blog</a>
      </span>
      <span>
        <a href="https://code.quarkus.io" class="button-cta secondary white">Start Coding</a>
      </span>
    </div>
  </div>
      </nav>
    </div>
  </div>
</div>

  <div class="content">
    <div class="post-page grid-wrapper">
  <div class="width-8-12 width-12-12-m doc-content">
    <div class="grid-wrapper">
      <div class="width-12-12">
        <p>
          <a href="/blog"><i class="fas fa-angle-left"></i> Back to all posts</a>
        </p>
      </div>
      <div class="width-12-12">
        <div class="post-date">
          September 15, 2020 
          
            <span class="tags"><a href="/blog/tag/reactive">#reactive</a><a href="/blog/tag/rest">#rest</a><a href="/blog/tag/mutiny">#mutiny</a><a href="/blog/tag/http">#http</a><a href="/blog/tag/pagination">#pagination</a></span>
          
        </div>
        <h1 class="post-title">Handling paginated APIs with Mutiny</h1>
        <div class="grid-wrapper">
          <div class="width-8-12 width-12-12-m byline-wrapper">
            
            
              <img class="headshot" src="https://www.gravatar.com/avatar/ab937f7df990a673446f1e30fd9ccfba">
            
            <p class="byline">By Clement Escoffier</p>
          </div>
          <div class="width-12-12">
              <div class="paragraph">
<p>At the beginning of the Mutiny adventure, my friend Alex came to me with an interesting problem.
Alex wanted to retrieve data from a REST service in a reactive manner.
So far, no problem, we have everything for this in our toolbox.
But, this service, as many services, is using pagination.
Ah! That makes things a bit more spicy.
Alex wanted to retrieve all the items and consume them as a stream, but you can&#8217;t retrieve the items in one batch.
You need to invoke the service for every page, extract the items and feed the stream.</p>
</div>
<div class="paragraph">
<p>So, how to achieve this in a reactive manner and build a proper stream of items without loosing your sanity?
Let&#8217;s have a look!</p>
</div>
<div class="sect1">
<h2 id="the-punk-api"><a class="anchor" href="#the-punk-api"></a>The Punk API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need an API.
Alex introduced me to the <a href="https://punkapi.com/documentation/v2">Punk API</a>, a REST API to retrieve beers.
That&#8217;s fun, and even better, it uses pagination.
We got our API!</p>
</div>
<div class="paragraph">
<p>If you call <code><a href="https://api.punkapi.com/v2/beers?page=1" class="bare">https://api.punkapi.com/v2/beers?page=1</a></code>, you get a JSON array like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
    {
        first beer
    },
    {
        second beer
    },
    // ...
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>I won&#8217;t show discuss the content of each object, the documentation page does a great job about that.
Let&#8217;s focus on the pagination aspect.
First, we passed the <code>page</code> query parameter, indicating which page we want.
Generally, when you retrieve a page, the API provides a way to know if there is a next page (a special field in the JSON document, or HTTP header), but the Punk API does not provide any hint.
So, to retrieve all the beers, we need to invoke the service for page 1, 2, 3&#8230;&#8203; until the returned JSON array is empty.</p>
</div>
<div class="paragraph">
<p>In an imperative world, to retrieve all the beers, you would do something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">List&lt;Beer&gt; beers = ...;
int page = 1;
List&lt;Beer&gt; batch = ...
do {
  batch= getBeersFromPage(page);
  beers.addAll(batch);
  page = page + 1;
} while (! batch.isEmpty());</code></pre>
</div>
</div>
<div class="paragraph">
<p>How can we achieve the same in a reactive manner and build a stream of beer?</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-pagination/mutiny-pagination.png" alt="mutiny pagination"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s proceed step by step.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retrieving-a-single-page"><a class="anchor" href="#retrieving-a-single-page"></a>Retrieving a single page</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, we need to see how we can retrieve a single page.
I&#8217;m going to use the Vert.x Web Client, but you can use any reactive HTTP clients providing a Mutiny API.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Create the client
WebClient client = WebClient.create(vertx, new WebClientOptions()
      .setDefaultHost("api.punkapi.com")
      .setDefaultPort(443)
      .setSsl(true)
);

// Retrieve the first page
Uni&lt;List&lt;Beer&gt;&gt; uni = client.get("/v2/beers?page=1")
      .send()
      .onItem().transform(Pagination::toListOfBeer);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This snippet creates the web client.
Then, we use that client and retrieve the first page.</p>
</div>
<div class="paragraph">
<p>When we receive the result (<code>onItem</code>), we transform the JSON array into a list of beers.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s extract this code in a method and take the page number as parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">private static Uni&lt;List&lt;Beer&gt;&gt; getPage(WebClient client, int page) {
    return client.get("/v2/beers?page=" + page)
            .send()
            .onItem().transform(Pagination::toListOfBeer);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So far, so good.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="retrieving-multiple-page"><a class="anchor" href="#retrieving-multiple-page"></a>Retrieving multiple page</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So, now, we know how to retrieve a single page and extract the items from it.
We just need to repeat this operation for every page, and provide a stream.</p>
</div>
<div class="paragraph">
<p>Mutiny provides a method to create a <code>Multi</code> by repeating multiple times a <code>Uni</code>.
Under the hood, it calls a method returning a <code>Uni</code> and subscribe on it.
But we need to make <em>progress</em>, and pass the current page.
Mutiny offers the possibility to store a state in order to let the method creating the <code>Uni</code> increments the page number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Multi.createBy().repeating().uni(AtomicInteger::new, page -&gt;
		getPage(client, page.incrementAndGet())
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code above creates a stream with the item emitted by the <code>Unis</code> returned by the <code>getPage</code> method.
We increment the page number (stored in an <code>AtomicInteger</code>) every time.
So, it retrieves the page 1, 2, 3 &#8230;&#8203; and every time emits the received <code>List&lt;Beer&gt;</code> downstream.</p>
</div>
<div class="paragraph">
<p>However, at some point, we must stop.
As we said earlier, we can stop when the returned list is empty:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Multi&lt;List&lt;Beer&gt;&gt; multi = Multi.createBy().repeating().uni(AtomicInteger::new, page -&gt;
     getPage(client, page.incrementAndGet())
)
.until(List::isEmpty);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>until</code> clause indicates when the iteration must be stopped.
It receives the retrieved list (produced by <code>getPage</code>), and when this list is empty, stops the repetition.
If the list still contains beers, it retrieves the next page.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unpacking-the-beers"><a class="anchor" href="#unpacking-the-beers"></a>Unpacking the beers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We now have a stream of list, and each list contain a set of beers.
We are almost there, but Alex wants a stream of beer.
So we need to unpack the beers.</p>
</div>
<div class="paragraph">
<p>The first approach to achieve this uses <code>transformToMultiAndConcatenate</code>, i.e. for each list create a new <code>multi</code> with the contained beers and concatenate these <code>multis</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Multi&lt;Beer&gt; multi = Multi.createBy().repeating().uni(AtomicInteger::new, page -&gt;
        getPage(client, page.incrementAndGet())
    )
    .until(List::isEmpty)
    .onItem().transformToMultiAndConcatenate(l -&gt; Multi.createFrom().iterable(l));</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Wondering about <code>concatenate</code>? Check out this <a href="https://quarkus.io/blog/mutiny-redis/">other blog post</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><span class="image"><img src="/assets/images/posts/mutiny-pagination/disjoint.png" alt="disjoint"></span></p>
</div>
<div class="paragraph">
<p>Because this is a common operation, Mutiny provides the <code>disjoint</code> method doing exactly the same:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Multi&lt;Beer&gt; multi = Multi.createBy().repeating().uni(AtomicInteger::new, page -&gt;
    getPage(client, page.incrementAndGet())
)
  .until(List::isEmpty)
  .onItem().disjoint();</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we are done!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-benefits-of-reactive"><a class="anchor" href="#the-benefits-of-reactive"></a>The benefits of reactive</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have our stream, it&#8217;s time to use it!
Let&#8217;s, for example, retrieve the first 10 beers with "IPA" (let&#8217;s be trendy) in their description:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">multi
    .transform().byFilteringItemsWith(beer -&gt; beer.description.contains("IPA"))
    .transform().byTakingFirstItems(10);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The advantage of our stream is that we won&#8217;t retrieve every page.
As soon as we have enough beers, we stop the repetition.
How? Because it informs the upstream that it does not need more items (<strong>cancellation</strong>) and that stops the repetition.
So, retrieving items from paginated APIs this way can reduce the number of requests and, as a consequence the load on the remote service.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="feel-thirsty"><a class="anchor" href="#feel-thirsty"></a>Feel thirsty?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wanna try this code, checkout this <a href="https://gist.github.com/cescoffier/18a326a5c057392bec54d95ec5a06ca6">gist</a>.
You can run it immediately with jbang:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">jbang https://gist.github.com/cescoffier/18a326a5c057392bec54d95ec5a06ca6</code></pre>
</div>
</div>
</div>
</div>
              
          </div>
          <div class="width-12-12"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://quarkus.io/blog/mutiny-pagination/&title=Handling paginated APIs with Mutiny" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <img src="/assets/images/share-page/icons_social-linkedin.png"/>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Handling paginated APIs with Mutiny&url=https://quarkus.io/blog/mutiny-pagination/&via=quarkusio&related=quarkusio" rel="nofollow" target="_blank" title="Share on Twitter">
    <img src="/assets/images/share-page/icons_social-twitter.png"/>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://quarkus.io/blog/mutiny-pagination/" rel="nofollow" target="_blank" title="Share on Facebook">
    <img src="/assets/images/share-page/icons_social-facebook.png"/>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://quarkus.io/blog/mutiny-pagination/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <img src="/assets/images/share-page/icons_social-reddit.png"/>
  </a>
  <a class="share-email" href="mailto:?subject=Handling paginated APIs with Mutiny&amp;body=Handling paginated APIs with Mutiny https://quarkus.io/blog/mutiny-pagination/" title="Share via Email" >
    <img src="/assets/images/share-page/icons_social-email.png"/>
  </a>
</div>
</div>
        </div>
      </div>
    </div>
  </div>
</div>

  </div>

  <div class="content project-footer">
  <div class="footer-section">
    <div class="logo-wrapper">
      <a href="/"><img src="/assets/images/quarkus_logo_horizontal_rgb_reverse.svg" class="project-logo" title="Quarkus"></a>
    </div>
  </div>
  <div class="grid-wrapper">
    <p class="grid__item width-3-12">Quarkus is open. All dependencies of this project are available under the <a href='https://www.apache.org/licenses/LICENSE-2.0' target='_blank'>Apache Software License 2.0</a> or compatible license.<br /><br />This website was built with <a href='https://jekyllrb.com/' target='_blank'>Jekyll</a>, is hosted on <a href='https://pages.github.com/' target='_blank'>Github Pages</a> and is completely open source. If you want to make it better, <a href='https://github.com/quarkusio/quarkusio.github.io' target='_blank'>fork the website</a> and show us what you’ve got.</p>

    
      <div class="width-1-12 project-links">
        <span>Navigation</span>
        <ul class="footer-links">
          
            <li><a href="/">Home</a></li>
          
            <li><a href="/guides">Guides</a></li>
          
            <li><a href="/community/#contributing">Contribute</a></li>
          
            <li><a href="/faq">FAQ</a></li>
          
            <li><a href="/get-started">Get Started</a></li>
          
        </ul>
      </div>
    
      <div class="width-1-12 project-links">
        <span>Contribute</span>
        <ul class="footer-links">
          
            <li><a href="https://twitter.com/quarkusio">Follow us</a></li>
          
            <li><a href="https://github.com/quarkusio">GitHub</a></li>
          
            <li><a href="/security">Security&nbsp;policy</a></li>
          
        </ul>
      </div>
    
      <div class="width-2-12 project-links">
        <span>Get Help</span>
        <ul class="footer-links">
          
            <li><a href="https://stackoverflow.com/questions/tagged/quarkus">Stack Overflow</a></li>
          
            <li><a href="https://quarkusio.zulipchat.com">Chat room</a></li>
          
            <li><a href="https://groups.google.com/forum/#!forum/quarkus-dev">Development mailing list</a></li>
          
        </ul>
      </div>
    

    
      <div class="width-4-12 more-links">
        <span>Quarkus is made of community projects</span>
        <ul class="footer-links">
          
            <li><a href="https://vertx.io/" target="_blank">Eclipse Vert.x</a></li>
          
            <li><a href="https://smallrye.io" target="_blank">SmallRye</a></li>
          
            <li><a href="https://hibernate.org" target="_blank">Hibernate</a></li>
          
            <li><a href="https://netty.io" target="_blank">Netty</a></li>
          
            <li><a href="https://resteasy.github.io" target="_blank">RESTEasy</a></li>
          
            <li><a href="https://camel.apache.org" target="_blank">Apache Camel</a></li>
          
            <li><a href="https://microprofile.io" target="_blank">Eclipse MicroProfile</a></li>
          
            <li><a href="https://code.quarkus.io/" target="_blank">And many more...</a></li>
          
        </ul>
      </div>
    
  </div>
</div>

  <div class="content redhat-footer">
  <div class="grid-wrapper">
    <span class="licence">
      <i class="fab fa-creative-commons"></i><i class="fab fa-creative-commons-by"></i> <a href="https://creativecommons.org/licenses/by/3.0/" target="_blank">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </span>
    <span class="redhat">
      Sponsored by
    </span>
    <span class="redhat-logo">
      <a href="https://www.redhat.com/" target="_blank"><img src="/assets/images/redhat_reversed.svg"></a>
    </span>
  </div>
</div>


  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>
  <script type="text/javascript" src="/assets/javascript/mobile-nav.js"></script>
  <script type="text/javascript" src="/assets/javascript/scroll-down.js"></script>
  <script src="/assets/javascript/satellite.js" type="text/javascript"></script>
  <script src="/guides/javascript/config.js" type="text/javascript"></script>
  <script src="/assets/javascript/search-filter.js" type="text/javascript"></script>
  <script src="/assets/javascript/guides-version-dropdown.js" type="text/javascript"></script>
  <script src="/assets/javascript/back-to-top.js" type="text/javascript"></script>
</body>

</html>
